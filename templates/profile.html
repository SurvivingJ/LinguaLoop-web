{% extends "base.html" %}

{% block title %}Profile - LinguaLoop{% endblock %}

{% block extra_css %}
<style>
    .profile-header {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        padding: 2rem;
        border-radius: 12px;
        margin-bottom: 2rem;
    }
    .language-card {
        cursor: pointer;
        transition: all 0.2s;
        border: 2px solid #e2e8f0;
    }
    .language-card:hover {
        border-color: #3b82f6;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .language-card.active {
        border-color: #3b82f6;
        background: #eff6ff;
    }
    .stat-card {
        border-left: 4px solid #3b82f6;
    }
</style>
{% endblock %}

{% block content %}
<div class="container" style="max-width: 1200px;">
    <!-- Header -->
    <div class="profile-header">
        <h1 class="mb-2"><i class="fas fa-user-circle me-2"></i>My Profile</h1>
        <p class="mb-0 opacity-90">Track your language learning progress</p>
    </div>

    <!-- Loading -->
    <div id="loadingState" class="text-center py-5">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-3 text-muted">Loading profile...</p>
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="text-center py-5 d-none">
        <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
        <h4>No Test History</h4>
        <p class="text-muted">Start taking tests to track your progress!</p>
        <a href="/tests" class="btn btn-primary mt-3">
            <i class="fas fa-book-reader me-2"></i>Browse Tests
        </a>
    </div>

    <!-- Profile Content -->
    <div id="profileContent" class="d-none">
        <!-- Language Selection -->
        <h5 class="mb-3"><i class="fas fa-globe me-2"></i>Select Language</h5>
        <div id="languageList" class="row g-3 mb-4"></div>

        <!-- Stats Section with Skill Tabs -->
        <div id="statsSection" class="d-none">
            <h5 class="mb-3"><i class="fas fa-chart-line me-2"></i>Statistics</h5>

            <!-- Skill Type Tabs -->
            <ul class="nav nav-tabs mb-3" id="skillTabs" role="tablist">
                <!-- Dynamically generated by renderSkillTabs() -->
            </ul>

            <!-- Stats Grid (now shows ONE skill at a time) -->
            <div id="statsGrid" class="row g-3 mb-4"></div>

            <!-- Test History Section -->
            <div id="historySection" class="d-none mt-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0"><i class="fas fa-history me-2"></i>Test History</h5>
                    <span id="historyCount" class="badge bg-secondary"></span>
                </div>
                <div id="historyList"></div>
                <div id="loadMoreContainer" class="text-center mt-3 d-none">
                    <button id="loadMoreBtn" class="btn btn-outline-primary">
                        Load More
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    'use strict';

    let profileData = null;
    let selectedLang = null;
    let selectedSkill = null;
    let testHistory = {};
    let historyOffset = {};
    const HISTORY_PAGE_SIZE = 25;

    document.addEventListener('DOMContentLoaded', function() {
        console.log('==================================================');
        console.log('=== PROFILE PAGE - DOMContentLoaded FIRED ===');
        console.log('==================================================');
        console.log('Timestamp:', new Date().toISOString());
        console.log('URL:', window.location.href);
        console.log('User agent:', navigator.userAgent);

        console.log('Calling loadProfile()...');
        loadProfile();

        // Wire up load more button
        const loadMoreBtn = document.getElementById('loadMoreBtn');
        console.log('Load more button element:', loadMoreBtn);
        if (loadMoreBtn) {
            loadMoreBtn.addEventListener('click', function() {
                console.log('Load more button clicked');
                loadTestHistory();
            });
        }
    });

    async function loadProfile() {
        console.log('=== LOAD PROFILE START ===');
        try {
            const token = localStorage.getItem('jwt_token');
            console.log('JWT token exists:', !!token);
            console.log('JWT token preview:', token ? token.substring(0, 20) + '...' : 'null');

            if (!token) {
                console.warn('No JWT token found, redirecting to login');
                window.location.href = '/login';
                return;
            }

            console.log('Fetching /api/users/elo...');
            const res = await fetch('/api/users/elo', {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            console.log('Response status:', res.status);
            console.log('Response ok:', res.ok);
            console.log('Response headers:', Object.fromEntries(res.headers.entries()));

            if (!res.ok) {
                if (res.status === 401) {
                    console.error('401 Unauthorized - redirecting to login');
                    window.location.href = '/login';
                }
                throw new Error(`Failed to load profile: ${res.status} ${res.statusText}`);
            }

            const data = await res.json();
            console.log('Raw API response:', JSON.stringify(data, null, 2));

            profileData = data.ratings;
            console.log('Profile data extracted:', JSON.stringify(profileData, null, 2));
            console.log('Profile data keys:', Object.keys(profileData || {}));
            console.log('Profile data empty?', !profileData || Object.keys(profileData).length === 0);

            document.getElementById('loadingState').classList.add('d-none');
            console.log('Loading state hidden');

            if (!profileData || Object.keys(profileData).length === 0) {
                console.log('No profile data - showing empty state');
                document.getElementById('emptyState').classList.remove('d-none');
            } else {
                console.log('Profile data exists - showing content');
                document.getElementById('profileContent').classList.remove('d-none');

                console.log('Calling renderLanguages()...');
                renderLanguages();

                const firstLang = Object.keys(profileData)[0];
                console.log('Auto-selecting first language:', firstLang);
                selectLanguage(firstLang);
            }

            console.log('=== LOAD PROFILE END ===');

        } catch (error) {
            console.error('=== LOAD PROFILE ERROR ===');
            console.error('Error type:', error.constructor.name);
            console.error('Error message:', error.message);
            console.error('Error stack:', error.stack);
            document.getElementById('loadingState').innerHTML =
                '<div class="alert alert-danger">Failed to load profile. Please refresh.</div>';
        }
    }

    function renderLanguages() {
        console.log('=== RENDER LANGUAGES START ===');
        const container = document.getElementById('languageList');
        console.log('Language list container:', container);

        const langs = Object.entries(profileData);
        console.log('Languages to render:', langs.length);
        console.log('Languages data:', JSON.stringify(langs, null, 2));

        const html = langs.map(([code, data]) => {
            console.log(`Rendering language: ${code}`, data);
            return `
            <div class="col-md-4">
                <div class="card language-card h-100 p-3" onclick="selectLanguage('${code}')">
                    <div class="d-flex align-items-center">
                        <span class="fs-1 me-3">${getFlag(code)}</span>
                        <div>
                            <h6 class="mb-1">${data.language_name}</h6>
                            <small class="text-muted">
                                ${Object.keys(data.skills).length} skill${Object.keys(data.skills).length !== 1 ? 's' : ''}
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        `;
        }).join('');

        console.log('Generated HTML length:', html.length);
        container.innerHTML = html;
        console.log('=== RENDER LANGUAGES END ===');
    }

    function renderSkillTabs() {
        console.log('=== RENDER SKILL TABS START ===');
        const container = document.getElementById('skillTabs');
        console.log('Skill tabs container:', container);

        const skills = Object.entries(selectedLang.skills);
        console.log('Skills to render:', skills.length);
        console.log('Skills data:', JSON.stringify(skills, null, 2));

        const html = skills.map(([skillCode, skill], index) => {
            console.log(`Rendering skill tab: ${skillCode}`, skill);
            return `
            <li class="nav-item" role="presentation">
                <button
                    class="nav-link ${index === 0 ? 'active' : ''}"
                    id="${skillCode}-tab"
                    data-skill="${skillCode}"
                    data-test-type-id="${skill.test_type_id}"
                    type="button"
                    role="tab">
                    ${skillCode === 'listening' ? 'üéß' : 'üìñ'} ${skill.skill_name}
                </button>
            </li>
        `;
        }).join('');

        console.log('Generated tabs HTML length:', html.length);
        container.innerHTML = html;

        // Add click handlers
        const tabs = container.querySelectorAll('.nav-link');
        console.log('Found tabs for click handlers:', tabs.length);
        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                console.log('Tab clicked:', this.dataset.skill);
                // Remove active from all tabs
                container.querySelectorAll('.nav-link').forEach(t => t.classList.remove('active'));
                this.classList.add('active');

                // Select skill
                const skillCode = this.dataset.skill;
                selectSkill(skillCode);
            });
        });

        console.log('=== RENDER SKILL TABS END ===');
    }

    window.selectLanguage = function(langCode) {
        console.log('=== SELECT LANGUAGE START ===');
        console.log('Selected language code:', langCode);

        selectedLang = profileData[langCode];
        console.log('Selected language data:', JSON.stringify(selectedLang, null, 2));

        // Update active state
        const cards = document.querySelectorAll('.language-card');
        console.log('Found language cards:', cards.length);
        cards.forEach((el, i) => {
            el.classList.remove('active');
            if (Object.keys(profileData)[i] === langCode) {
                el.classList.add('active');
                console.log('Activated card:', i);
            }
        });

        const statsSection = document.getElementById('statsSection');
        console.log('Stats section element:', statsSection);
        statsSection.classList.remove('d-none');
        console.log('Stats section shown');

        // Render skill tabs
        console.log('Calling renderSkillTabs()...');
        renderSkillTabs();

        // Auto-select first skill
        const skills = Object.keys(selectedLang.skills);
        console.log('Available skills:', skills);
        const firstSkill = skills[0];
        console.log('Auto-selecting first skill:', firstSkill);
        selectSkill(firstSkill);

        console.log('=== SELECT LANGUAGE END ===');
    };

    function selectSkill(skillCode) {
        console.log('=== SELECT SKILL START ===');
        console.log('Skill code:', skillCode);

        selectedSkill = selectedLang.skills[skillCode];
        console.log('Selected skill data:', JSON.stringify(selectedSkill, null, 2));

        selectedSkill.code = skillCode;  // Store skill code for later use
        console.log('Skill code stored on object');

        console.log('Calling renderStats()...');
        renderStats();

        console.log('Calling loadTestHistory()...');
        loadTestHistory();

        console.log('=== SELECT SKILL END ===');
    }

    function renderStats() {
        console.log('=== RENDER STATS START ===');
        const container = document.getElementById('statsGrid');
        console.log('Stats grid container:', container);

        const skill = selectedSkill;
        const skillCode = skill.code;
        console.log('Rendering stats for skill:', skillCode);
        console.log('Skill data:', {
            name: skill.skill_name,
            elo: skill.elo_rating,
            tests: skill.tests_taken,
            lastTest: skill.last_test_date,
            volatility: skill.volatility
        });

        const html = `
            <div class="col-12">
                <div class="card stat-card p-4">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <small class="text-muted text-uppercase fw-semibold">${skill.skill_name}</small>
                            <h1 class="mb-0 mt-2">${skill.elo_rating}</h1>
                            <small class="text-muted">ELO Rating</small>
                        </div>
                        <span style="font-size: 3rem;">${skillCode === 'listening' ? 'üéß' : 'üìñ'}</span>
                    </div>
                    <div class="row mt-3 pt-3 border-top">
                        <div class="col-md-6 text-center">
                            <h3 class="mb-0">${skill.tests_taken}</h3>
                            <small class="text-muted">Tests Taken</small>
                        </div>
                        <div class="col-md-6 text-center">
                            <h3 class="mb-0">${formatDate(skill.last_test_date)}</h3>
                            <small class="text-muted">Last Test</small>
                        </div>
                    </div>
                </div>
            </div>
        `;

        console.log('Generated stats HTML length:', html.length);
        container.innerHTML = html;
        console.log('=== RENDER STATS END ===');
    }

    async function loadTestHistory() {
        console.log('=== LOAD TEST HISTORY START ===');
        try {
            const cacheKey = `${selectedLang.language_id}_${selectedSkill.test_type_id}`;
            console.log('Cache key:', cacheKey);
            console.log('Language ID:', selectedLang.language_id);
            console.log('Test type ID:', selectedSkill.test_type_id);

            // Initialize cache for this language+skill if needed
            if (!testHistory[cacheKey]) {
                console.log('Initializing cache for:', cacheKey);
                testHistory[cacheKey] = [];
                historyOffset[cacheKey] = 0;
            }

            const offset = historyOffset[cacheKey];
            console.log('Current offset:', offset);

            const url = `/api/tests/history?language_id=${selectedLang.language_id}&test_type_id=${selectedSkill.test_type_id}&limit=${HISTORY_PAGE_SIZE}&offset=${offset}`;
            console.log('Fetching history from:', url);

            const res = await fetch(url, {
                headers: { 'Authorization': `Bearer ${localStorage.getItem('jwt_token')}` }
            });

            console.log('History response status:', res.status);
            console.log('History response ok:', res.ok);

            if (!res.ok) {
                const errorText = await res.text();
                console.error('History request failed:', errorText);
                throw new Error(`Failed to load history: ${res.status}`);
            }

            const data = await res.json();
            console.log('History API response:', JSON.stringify(data, null, 2));

            const newTests = data.tests || [];
            console.log('New tests loaded:', newTests.length);

            // Append to cache
            const previousLength = testHistory[cacheKey].length;
            testHistory[cacheKey] = [...testHistory[cacheKey], ...newTests];
            historyOffset[cacheKey] += newTests.length;

            console.log('Cache updated:', {
                previous: previousLength,
                current: testHistory[cacheKey].length,
                newOffset: historyOffset[cacheKey]
            });

            const historySection = document.getElementById('historySection');
            console.log('History section element:', historySection);
            historySection.classList.remove('d-none');

            const historyCount = document.getElementById('historyCount');
            console.log('History count element:', historyCount);
            historyCount.textContent = `${testHistory[cacheKey].length} tests`;

            console.log('Calling renderHistory()...');
            renderHistory(cacheKey);

            const loadMoreContainer = document.getElementById('loadMoreContainer');
            if (newTests.length === HISTORY_PAGE_SIZE) {
                console.log('Showing load more button (full page received)');
                loadMoreContainer.classList.remove('d-none');
            } else {
                console.log('Hiding load more button (last page)');
                loadMoreContainer.classList.add('d-none');
            }

            console.log('=== LOAD TEST HISTORY END ===');

        } catch (error) {
            console.error('=== LOAD TEST HISTORY ERROR ===');
            console.error('Error type:', error.constructor.name);
            console.error('Error message:', error.message);
            console.error('Error stack:', error.stack);
        }
    }

    function renderHistory(cacheKey) {
        console.log('=== RENDER HISTORY START ===');
        console.log('Cache key:', cacheKey);

        const container = document.getElementById('historyList');
        console.log('History list container:', container);

        const history = testHistory[cacheKey] || [];
        console.log('History items to render:', history.length);
        console.log('History data:', JSON.stringify(history, null, 2));

        if (history.length === 0) {
            console.log('No history - showing empty message');
            container.innerHTML = `<div class="alert alert-info">No ${selectedSkill.skill_name.toLowerCase()} tests for this language yet.</div>`;
            return;
        }

        const html = history.map((test, index) => {
            console.log(`Rendering history item ${index}:`, test);
            const scoreClass = test.percentage >= 80 ? 'success' : test.percentage >= 60 ? 'primary' : test.percentage >= 40 ? 'warning' : 'danger';

            return `
                <div class="card mb-2">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">${test.test_title || 'Unknown Test'}</h6>
                                <small class="text-muted">
                                    <i class="far fa-calendar me-1"></i>${formatDate(test.created_at)}
                                </small>
                            </div>
                            <div class="text-end ms-3">
                                <h5 class="mb-0 text-${scoreClass}">${test.score}/${test.total_questions}</h5>
                                <small class="text-muted">ELO: ${test.user_elo_after || 'N/A'}</small>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        console.log('Generated history HTML length:', html.length);
        container.innerHTML = html;
        console.log('=== RENDER HISTORY END ===');
    }

    function getFlag(langCode) {
        console.log('Getting flag for:', langCode);
        // Support both short codes (cn, jp, en) and full names (chinese, japanese, english)
        const flags = {
            'cn': 'üá®üá≥', 'chinese': 'üá®üá≥',
            'en': 'üá∫üá∏', 'english': 'üá∫üá∏',
            'jp': 'üáØüáµ', 'japanese': 'üáØüáµ',
            'ko': 'üá∞üá∑', 'korean': 'üá∞üá∑',
            'fr': 'üá´üá∑', 'french': 'üá´üá∑'
        };
        const flag = flags[langCode?.toLowerCase()] || 'üåê';
        console.log('Returned flag:', flag);
        return flag;
    }

    function formatDate(dateStr) {
        if (!dateStr) return 'N/A';
        const date = new Date(dateStr);
        const days = Math.floor((new Date() - date) / (1000 * 60 * 60 * 24));
        if (days === 0) return 'Today';
        if (days === 1) return 'Yesterday';
        if (days < 7) return `${days} days ago`;
        if (days < 30) return `${Math.floor(days / 7)} weeks ago`;
        return date.toLocaleDateString();
    }

})();
</script>
{% endblock %}
